
\section{Ugeopgave 1-3}
\label{sec:ugeopgave-1-3}

Denne ugeopgave beskæftigede sig med forståelse og videreudvikling af
en raytracer.

En raytracer er en metode til at beregne, hvordan 3D-scener vil
fremstå. Selve \emph{tracingen} foregår ved at der udsendes en stråle
fra øjet, der går igennem hver pixel i scenen. Denne stråle spores så,
indtil den rammer et objekt, og returnerer farven, der er på det
pågældende sted på det pågældende objekt. Idét objektets farve kan
ændres, alt efter hvilke lyskilder, der peger på det, hvilke
egenskaber objektet har (reflektionsgrad fx) samt hvilke objekter der
er andre steder i scenen, sendes der fra ``nedslagspunktet'' en ny
stråle ud, der besøger andre steder i scenen.

Disse stråleudsendinger kan stoppes ved forskellige kriterier:

\begin{itemize}
\item Hvis strålen rammer en perfekt diffus overflade (da der ellers
  skulle udsendes stråler i alle retninger og dermed uendeligt mange)
\item Hvis strålen er over en hvis generation (dvs. at der fx fra Ã¸jet
  maksimalt udsendes 5 stråler, for at finde værdien af én pixel)
\item Hvis strålens energi ligger under en forudbestemt tærskel for
  minimumsenergi
\end{itemize}

\subsection{Del 1: UML-diagram}
\label{sec:del-1:-uml}

Følgende er et begrænset UML-diagram over den udleverede raytracer:


\subsection{Del 2: Shade-funktionalitet}
\label{sec:shade-funktionalitet}

I raytraceren er de fem følgende termer implementeret:

\begin{itemize}
\item Omgivende lys (ambient light)
\item Diffus reflektion (Lambertian shading)
\item Specular highlights (Phong highlights)
\item Specular reflektion
\item Transmission
\end{itemize}

De første tre er lokale betragtninger, og kræver derfor ikke
rekursion, idet det ikke er nødvendigt at betragte resten af scenen
for at beregne dem.

I vores implementering, udsendes der ikke ``børnestråler'' ved perfekt
diffuse overflader og desuden stoppes strålerne efter 5 generationer.

Bortset fra begrænsningen på rekursionsdybden er al relevant kode
foretaget i \texttt{Surface.cpp}.

Alle ``bidrag'' fra de forskellige termer adderes og multipliceres til
sidst med objektets grundfarve i det pågældende punkt.
%
På figur \ref{fig:nolight} ses den udleverede scene, uden nogen
lysbidrag.

\begin{figure}[htbp]
  \centering
  \includegraphics[width=8cm]{screenshots/exc01-01.png}
  \caption{Ingen lysbidrag}
  \label{fig:nolight}
\end{figure}

\paragraph{Omgivende lys}
\label{sec:omgivende-lys}

Dette er implementeret ved at multiplicere scenens omgivende lys med
faktoren for omgivende lys, \texttt{k\_ambient}.
%
På figur \ref{fig:ambient} ses scenen med omgivende lys tilsat.

\begin{figure}[htbp]
  \centering
  \includegraphics[width=8cm]{screenshots/exc01-02.png}
  \caption{Omgivende lys}
  \label{fig:ambient}
\end{figure}

\paragraph{Diffus reflektion}
\label{sec:diffus-reflektion}

Dette er implementeret direkte fra formlen, der er givet i bogen:
%
\[
k_{diffuse} \cdot (\mathbf{N} \cdot \mathbf{L}) \cdot I
\]
%
Hvor $\mathbf{N}$ er normalvektoren, $\mathbf{L}$ er lysvektoren og
$I$ er lysintesiteterne i scenen.
%
På figur \ref{fig:diffus} ses scenen med omgivende lys samt diffus
reflektion.

\begin{figure}[htbp]
  \centering
  \includegraphics[width=8cm]{screenshots/exc01-04.png}
  \caption{Omgivende lys samt diffus reflektion}
  \label{fig:diffus}
\end{figure}

\paragraph{Specular (phong) highlights}
\label{sec:spec-phong-highl}

Dette er ligeledes implementeret direkte fra formlen i bogen:
%
\[
(\mathbf{N} \cdot \mathbf{H})^{n} \cdot k_{highlight} \cdot I
\]
%
I dette tilfælde er $\mathbf{H}$ den såkaldte halvejsvektor.
%
På figur \ref{fig:phong} ses scenen med den samlede lokale
belysning.

\begin{figure}[htbp]
  \centering
  \includegraphics[width=8cm]{screenshots/exc01-06.png}
  \caption{Samlet lokal belysning}
  \label{fig:phong}
\end{figure}

\paragraph{Specular reflektion}
\label{sec:specular-reflektion}

Hvis overfladen, strålen rammer ikke er perfekt diffus (dvs. hvis
\texttt{k\_diffuse < 1}, udsendes der en ekstra stråle, hvis retning
er beregnet ud fra følgende formel fra bogen:
%
\[
\mathbf{R} = 2 (\mathbf{N} \cdot \mathbf{L})\mathbf{N} - \mathbf{L}
\]
%
Strålen får desuden inkrementeret sin niveau med én. Dette bruges til
at stoppe rekursionen, når den har nået en vis dybde.
%
På figur \ref{fig:reflektion} ses scenen med lokal belysning samt
reflektion.

\begin{figure}[htbp]
  \centering
  \includegraphics[width=8cm]{screenshots/exc01-07.png}
  \caption{Lokal belysning samt reflektion}
  \label{fig:reflektion}
\end{figure}

\paragraph{Transmission}
\label{sec:transmission}

Hvis overfladen, strålen rammer, har \texttt{refraction\_index > 0}
udsendes der en transmissionsstråle, hvis der ikke opstår total intern
reflektion.

Strålens retning er ikke bestemt ud fra formlen i bogen, men fra en
udledt, ækvivalent formel, beskrevet i artiklen ``Derivation of
Refraction Formulas''\footnote{Skrevet af Paul S. Heckbert. Artiklen
  stammer fra ``Introduction to Ray Tracing'', (Andrew Glassner, ed.),
  Academic Press, London, 1989, side 263-293. Artiklen er vedlagt på
  CD.}.
%
\[
  c_1 = - \mathbf{I} \cdot \mathbf{N}
\]
\[
  c_2 = \sqrt{1 - \mu^2 (1 - c_1^2)}
\]
\[
  \mathbf{T} = \mu \mathbf{I} + (\mu c_1 - c_2) \mathbf{N}
\]
% 
Hvis $c_2$ er imaginær, opstår der total intern reflektion.
%
På figur \ref{fig:transmission} ses scenen med lokal belysning,
reflektion samt transmission.

\begin{figure}[htbp]
  \centering
  \includegraphics[width=8cm]{screenshots/exc01-08.png}
  \caption{Lokal belysning, reflektion samt transmission}
  \label{fig:transmission}
\end{figure}

\subsection{Del 3: Raytracerteori}
\label{sec:del-3:-raytr}

\paragraph{Tre metoder til at forøge hastigheden på algoritmen}
\label{sec:giv-tre-metoder}

Idet det er undersøgelsen af hvorvidt en stråle rammer en figur, der
er flaskehalsen i algoritmen, er det muligt at forøge hastigheden ved
brug af datastrukturer, der udnytter de fysiske egenskaber og
placeringer ved objekterne i en scene. Disse kunne fx være:

\begin{itemize}
\item \emph{Bounding box} hierakier
\item BSP-træer
\item Octræer (\emph{octrees})
\end{itemize}

\paragraph{Forklaring af, hvordan accelerationen foregår}
\label{sec:forkl-af-hvord}

Basalt set, er det hurtigere at undersøge om en stråle går igennem en
omgivende kasse (\emph{bounding box}) end en primitiv struktur
(trekant, ellipse, osv). Derfor vil den første metode give en
hurtigere algoritme, mod at præcisionen vil blive lavere. Dette
skyldes at den omgivende kasse ikke vil slutte helt tæt omkring sin
figur, og strålen vil derfor også tro at den har ramt figuren, når den
rammer noget af det tomme rum i den omgivende kasse.

BSP-træer og Octræer udnytter begge de fysiske placeringer af
objekterne i en scene. Scenen deles op i mindre dele, der er
organiseret, så der fx er dele, der ikke indeholder nogen
objekter. Dermed behøver man ikke undersøge om en stråle rammer
objekter, hvis strålen går igennem sådan en del. Går strålen igennem
en del, der indeholder objekter, vil man kunne nøjes med at undersøge
om strålen rammer netop de objekter, der er i den specifikke
del. Dette er i modsætning til den naive algoritme, der for hver
stråle undersøger om hvert enkelt objekt rammes.

\paragraph{Forklaring af hvordan raytracing kan bruges til \emph{hidden surface removal}}
\label{sec:forkl-af-hvord-1}

Når en stråle rammer flere objekter, vil det udelukkende være det
objekt, med lavest afstand, der regnes med. Bagvedliggende objekter
vil altså smides bort. Dette resulterer i, at det kun vil være det
forreste objekt der tegnes, og dermed er \emph{hidden surface removal}
opnået.

\paragraph{Forklaring af hvordan \emph{point shading} kan bruges i raytracing}
\label{sec:forkl-af-hvord-2}

En \emph{point shading}-metode, såsom Phongs, kan bruges til at
beregne den lokale belysning i et punkt. Da hver stråle beregnes
rekursivt, kan \emph{point sading}-metoder bruges til at akkumulere
lokale belysninger, der kan observeres fra et punkt.

\paragraph{Betydningen af at placere øjet uendeligt langt væk}
\label{sec:betydningen-af-at}

Hvis øjet bliver placeret uendeligt langt væk, vil alle stråler blive
sendt ud i retningen af normalvektoren fra vores \emph{view plane}. Dermed
kan vi bruge parallel projektion af scenen over på vores \emph{view
  plane}, og dermed straks have det første objekt, hver stråle
rammer. Desuden kan vi lave en ret lille omgivende kasse for scenen.

Desværre kan vi ikke beskære objekter til vores \emph{view volume}
fjerne bagsider af objekter (\emph{back-face culling}), da strålerne
udsendes rekursivt.

\paragraph{Problemer ved at bruge raytracing på fx NURBS-overflader}
\label{sec:problemer-ved-at}

Selvom NURBS-overflader er eksakte, analytiske og meget pladsmæssigt
økonomiske repræsentationer, er det beregningsmæssigt meget dyrt at
finde krydsningspunkter mellem NURBS-overflader og lysstråler. Man kan
omdanne overfladerne til polygoner, men NURBS-overflader skal bruge
mange polygoner for at få en god approksimation, og
krydspunktsberegningerne vil derfor stadig være dyre.

\paragraph{Metode til repræsentering af solide objekter til visualisering i en raytracer}
\label{sec:metode-til-repr}

Den mest hensigtsmæssige metode til repræsentering af solide objekter,
der jvf. det tidligere afsnit om hastighedsforøgelse, er at dele
objekterne op i ikkeoverlappende, primitive dele, idet
krydspunktsundersøgelse for disse er billige. Endvidere kan objekterne
på denne måde direkte repræsenteres af datastrukturer som fx octræer
eller bsp-træer, hvilket vil gøre raytracerens arbejde betydeligt
lettere.

\subsection{Del 4: Udvidelse af raytraceren}
\label{sec:del-4:-udvidelse}

Vores udvidelse af raytraceren er ganske simpel, idet vi 1) ikke ville
bruge for meget tid på udvidelsen og 2) gerne ville have noget
interessant at implementere til det endelige projekt.

Derfor har vi blot valgt at implementere hårde skygger i vores
raytracer. De er implementeret på følgende måde:

Når en stråle rammer noget, udsendes der en stråle direkte mod
lyskilden fra ``nedslagspunktet''. Rammer denne anden stråle et
objekt, ligger nedslagspunktet i skygge og de lokale lysbidrag (diffus
reflektion og Phong highlights) medregnes ikke.
%
På figur \ref{fig:hardshadow} ses den endelige scene, tilsat hårde skygger.

\begin{figure}[htbp]
  \centering
  \includegraphics[width=8cm]{screenshots/exc01-09.png}
  \caption{Den endelige scene tilsat hårde skygger}
  \label{fig:hardshadow}
\end{figure}

%%% Local Variables: 
%%% mode: latex
%%% TeX-master: "report_main"
%%% End: 
